# Cribl Practice Environment
---
This lab allows you to learn by doing. It assumes you are using the default lab environment based on the Docker file.  There shouldn't be a fee associated with anything in this lab. 

This lab is designed to give you prompts so that you can discover how to execute these steps. If you are having trouble, see [Help Section](#help).

<!-- ## Architecture
 ```mermaid
 flowchart TD;
     Leader-- B[Worker Group];
     Leader-- C[Edge Fleet];
    
     subgraph B[Worker Group]
       direction LR
     b1[Worker 1]
     b2[Worker 2]
     end
     subgraph C[Edge Fleet]
       direction LR
       c1[Node 1] 
       c2[Node 2]
     end
```-->

# Part 1: Stream Set up
1. Start your Stream container in Docker
   
   `docker-compose.yml up -d --build 'stream'`

2. Connect to Git

   > [!Tip]
   > Create git account at [Github.com](https://www.github.com)

3. Configure so that all git commit messages are generated by Copilot
4. Add a custom logo to login screen
5. Add a banner labeled `My Learning Lab`
6. Configure an HA Leader
7. Configure TLS for Leader/Worker Group communication
   - A self-sign cert was created on the Stream image
   - In Docker, click on the Stream image
   - Click on the **Files** tab
   - Navigate to the **root** folder
   - There should be a cert labeled **criblcertificate.crt**
   - Download that to your local machine (Right-click, Save)
   - Add the certificate to your browser ([Instructions](https://support.apple.com/guide/keychain-access/change-the-trust-settings-of-a-certificate-kyca11871/mac) for Mac User)
   - The public and private key are both located in /etc/ssl on the Stream server. They are named **certificate.pem** and **privatekey.pem**, respectively
8. Disable API Service on Workers
9. Ensure you are always on the latest version of Cribl
10. Create the following notifications
11. Ensure any node only uses 1 process
   > [!IMPORTANT]
   > This is not a recommended practice. This is simply to show how to configure and since we are using a Docker environment we want to limit the number of CPUs that are being used.

# Part 2: Access Management

1. Create the following teams

   | Name           | Workspace Permissions | Product Permissions                |
   | -------------- | --------------------- | ---------------------------------- |
   | SOC_Team       | Admin                 | Stream: Admin; Edge: User          |
   | ITOps_Team     | User                  | Stream: User; Edge: User           |
   | Marketing_Team | User                  | Stream: Read Only; Edge: No Access |
   | East_Team      | User                  | Stream: Read Only; Edge: User      |
   | West_Team      | User                  | Stream: Read Only; Edge: User      |


2. Add the following users and add the to the appropriate team 
   
| Name              | Username    | Email                     | Workspace | Team           | Product                            |
| ----------------- | ----------- | ------------------------- | --------- | -------------- | ---------------------------------- |
| Gertie Goatley    | ggoatley    | ggoatley@evilcoffee.co    | User      | Marketing_Team | Stream: Read Only; Edge: User      |
| Billy Goatsworth  | bgoatsworth | bgoatsworth@evilcoffee.co | User      | Marketing_Team | Stream: User; Edge: User           |
| Lex Luthor        | lluthor     | lluthor@evilcoffee.co     | User      | ITOps_Team     | Stream: User; Edge: User           |
| Jafar Bleatmore   | jbleatmore  | jbleatmore@evilcoffee.co  | User      | ITOps_Team     | Stream: User; Edge: User           |
| Thanos Goatkins   | tgoatkins   | tgoatkins@evilcoffee.co   | User      | SOC_Team       | Stream: Admin; Edge: Admin         |
| Cruella de Vil    | cdevil      | cdevil@evilcoffee.co      | User      | SOC_Team       | Stream: Read Only; Edge: Read Only |
| Poison Ivy        | pivy        | pivy@evilcoffee.co        | User      | East_Team      | Stream: No Access; Edge: No Access |
| Venom Woolington  | vwoolington | vwoolington@evilcoffee.co | User      | East_Team      | Stream: User; Edge: User           |
| Loki Lambkin      | llambkin    | llambkin@evilcoffee.co    | User      | West_Team      | Stream: User; Edge: User           |
| Ursula Kiddington | ukiddington | ukiddington@evilcoffee.co | User      | West_Team      | Stream: User; Edge: No Access      |

> **Questions**
>1. Will Venom have access to Edge?
>2. What type of access will Loki have to Edge?
>3. Will Ursula have access to Edge?
>2. What type of access will Billy have to Stream?
>3. Will Cruella have any access?
>4. What type of access will Poison Ivy have to either product?
   
1. Test SAML Authenication Configuration
   - https://dummyidp.com/

# Part 3: Project Silos

1. Start 1 Worker and MinIO in Docker

   `docker-compose up -d --build worker --scale worker=2`

2. Create 2 new Worker Groups called `East` and `West`.

3. Create 5 different datagens:
   - syslog
   - weblog
   - fortinet
   - crowdstrike_fdr

4. Connect to MinIO and create 3 buckets:
   - syslog
   - weblog
   - security

5. Create the following subscriptions:

   | Subscription Name | Data                  | Pipeline |
   | ----------------- | --------------------- | -------- |
   | syslog_logs       | syslog                | passthru |
   | web_logs          | weblog                | passthru |
   | security_logs     | fortinet, crowdstrike | passthru |

6. Create projects for the appropriate teams.

7. Create pipelines to perform the following functions:

   | Pipeline | Function                                                                                                                                                                                                                                                                       |
   | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
   | syslog   | Remove `source` and `procid`.<br>Remove `future_use_0`, `future_use_1`, `future_use_2`, `future_use_3`, `future_use_4`, `device_group_hierarchy_level_1`, `device_group_hierarchy_level_2`, `device_group_hierarchy_level_3`, `device_group_hierarchy_level_4`, `tunnel_type`. |
   | weblog   | Tag data with `index=weblogs`.                                                                                                                                                                                                                                                 |
   | fortinet | Add `index=weblogs`.<br>Remove `appid`, `dstuuid`, `mastersrcmac`, `poluuid`, `srcuuid`, `utmref`, `date`.<br>Remove events with `multicast` & `vpn`.                                                                                                                          |

8. Send data to the appropriate destination.


## Other Tasks
1. Create fleets to organize the following nodes:
2. Ensure disconnected nodes are removed after 10 minutes
3. When a new node is connected ensure it automatically gets moved into a fleet based on## Stream
4. Connect to SIEM
5. Configure CriblVision
6. HA Leader
7. PQ
10. Replay
11. REST Collectors
12. Event breakers
8. Packs
9. Lookups
10. Mapping

## Help
Click on the section to get a step-by-step solution.

<details>
   <summary><b>Connect to Git</b></summary>

   1. Create an account at Github
   2. Create a new repository called `cribl`
      > **Question:** Is it required that the repo is called `cribl`?
      - Visibility should be private. See [Docs](https://docs.cribl.io/stream/securing-onprem#set-your-remote-git-repo-to-private) for more info.
      - Do not include .gitignore, README.md or a license. 
      > **Question: Why shouldn't you include these?**
      >
      > Answer: [Docs](https://docs.cribl.io/stream/version-control#securing-remote-repos)
      > 
   3. Create a personal access token ([Docs](https://docs.cribl.io/stream/version-control#connecting-to-remote-with-https))
      - In Github, click on your profile picture
      - Go to Settings, Developer Settings (at the very bottom)
      - Create a classic token
      - Set the expiration to 60 days
      - Select the **repo** scope
      - Generate & copy token
   4. In your Cribl console, navigate to Settings, Global, System, Git Settings
   5. Create your remote URL using this format: `https://<username>:<token>@github.com/<owner>/<repository>.git`
   6. Change Git Authentication Type to **None**
   7. On the **Copilot** tab, toggle **Generate commit messages automatically with Cribl Copilot**
   8. Commit & Push
   9. Check to make sure changes were sent to Github
</details>

<details>
   <summary><b>Custom Login Page</b></summary>

   Follow the steps [here](https://docs.cribl.io/stream/settings-login-page/#configure-custom-login-page)

</details>

<details>
   <summary><b>Custom Banner</b></summary>

   Follow these [steps](https://docs.cribl.io/stream/settings-banners/)

</details>

<details>
   <summary><b>Connect Minio</b></summary>

   Resource: [Docs](https://docs.cribl.io/stream/destinations-minio/)

   ## MinIO Settings
   1. Create a bucket in MinIO
   2. Create an Access Key

   ### General Settings
   3. **MinIO endpoint URL:** http://minio:9000
   4. **Backpressure behavior:** Drop

   ### Authenication
   5. **Authenication method:** Manual
   6. Add your access and secret key

   ### Advanced Settings
   7. **Disk space protection:** Drop
   8. **Remove empty staging directories** Turn off
   9. **Reject unauthorized certificates:** Turn off
   10. **Verify if bucket exists:** Turn off
</details>

<details>
   <summary><b>Connect Leader Securely</b></summary>

   Follow these [steps](https://docs.cribl.io/stream/securing-communications#secure-via-the-ui)
   
</details>

<details>
   <summary><b>Disable API Service on Workers</b></summary>

   Follow these [steps](https://docs.cribl.io/stream/securing-communications#disable-api-service)
   
</details>